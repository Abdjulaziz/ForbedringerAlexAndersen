<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <script src="lib/main.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.css"
            rel="stylesheet"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.css"
            rel="stylesheet"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.1/css/all.css"
            rel="stylesheet"
        />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"
        ></script>
        <link href="lib/main.css" rel="stylesheet" />
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                var calendarEl = document.getElementById("calendar1");
                var calendar1 = new FullCalendar.Calendar(calendarEl, {
                    timeZone: "local",
                    firstDay: 1,
                    initialView: "dayGridMonth",
                    locale: "local",
                    height: "auto",
                    headerToolbar: false,
                    eventColor: "#ffae42",
                    dateClick: function (info) {
                        if (info.dayEl.dataset.availableFrom || info.dayEl.dataset.availableTo) {
                            $("#dateStatus").html(
                                info.dayEl.dataset.availableFrom +
                                    " - " +
                                    info.dayEl.dataset.availableTo
                            );
                            $("#fra").val(info.dayEl.dataset.availableFrom);
                            $("#til").val(info.dayEl.dataset.availableTo);
                        } else {
                            $("#dateStatus").html("Ledig");
                            $("#fra,#til").val("");
                        }

                        //Add availability on button click
                        $("#dateDate").html(info.dateStr);
                        $("#onDateClickModal").modal("show");

                        $("#fra,#til").unbind("change");
                        $("#fra,#til").on("change", function () {
                            $("#dateStatus").html(fra.value + " - " + til.value);
                        });

                        $("#saveDateInfo").unbind("click");
                        $("#saveDateInfo").click(function () {
                            if ($("#fra").val() && $("#til").val()) {
                                info.dayEl.dataset.availableFrom = fra.value;
                                info.dayEl.dataset.availableTo = til.value;

                                let startTime = info.dayEl.dataset.availableFrom;
                                let endTime = info.dayEl.dataset.availableTo;
                                let date = Date.parse(info.dateStr);
                                if (!isNaN(date.valueOf())) {
                                    // valid?
                                    calendar1.addEvent({
                                        id: 1,
                                        title: startTime + " - " + endTime,
                                        start: date,
                                        allDay: true,
                                    });
                                } else {
                                    alert("Invalid date.");
                                }
                                $("#onDateClickModal").modal("hide");
                            } else {
                                alert("Tidsrum skal udfyldes");
                            }
                            /*  if ( $("#fra").val() && $("#til").val() == not){ */
                        });

                        $("#clearDateInfo").unbind("click");
                        //Delete all info from date on button click
                        $("#clearDateInfo").click(function () {
                            $("#onDateClickModal").modal("hide");
                            $("#dateStatus").html("Ledig");
                            $("#fra").val("");
                            $("#til").val("");
                            info.dayEl.dataset.availableFrom = "";
                            info.dayEl.dataset.availableTo = "";
                            var event = calendar1.getEventById("1");
                            event.remove();
                        });
                    },
                });

                calendar1.render();

                //Second calendar - Redigere rådighed dato
                var singleDateClicks = [];
                var calendarEl = document.getElementById("calendar2");
                var calendar2 = new FullCalendar.Calendar(calendarEl, {
                    timeZone: "local",
                    locale: "local",
                    firstDay: 1,
                    initialView: "dayGridMonth",
                    height: 500,
                    headerToolbar: false,
                    eventColor: "#00904A",

                    dateClick: function (info) {
                        let date = Date.parse(info.dateStr);
                        var event = calendar2.getEventById(date);
                        var eventObj1 = {
                            id: date,
                            title: "",
                            start: date,
                            allDay: true,
                        };
                        /* for (var i = 0; i < singleDateClicks.length; i++) {
                            singleDateClicks.push(eventObj1);
                        } */
                        singleDateClicks.push(eventObj1);
                        console.log(singleDateClicks);
                        if (event !== null) {
                            event.remove();
                        } else {
                            if (!isNaN(date.valueOf())) {
                                calendar2.addEvent(eventObj1);
                            } else {
                                alert("Ugyldig dato");
                            }
                        }
                    },
                });
                calendar2.render();

                $("#availability").on("click", function () {
                    setTimeout(function () {
                        calendar2.updateSize();
                    }, 210);
                });

                var eventObj2;
                function isObjectEmpty(object) {
                    var isEmpty = true;
                    for (keys in object) {
                        isEmpty = false;
                        break; // exiting since we found that the object is not empty
                    }
                    return isEmpty;
                }

                $("#savePeriod").on("click", function () {
                    let start = Date.parse(document.getElementById("datoStart").value);
                    let end = Date.parse(document.getElementById("datoEnd").value) + 86400000;

                    eventObj2 = {
                        id: start,
                        title: "",
                        start: start,
                        end: end,
                        allDay: true,
                    };

                    calendar2.addEvent(eventObj2);
                });
                $("#saveToCalender").on("click", function () {
                    if (singleDateClicks.length > 0) {
                        for (var i = 0; i < singleDateClicks.length; i++) {
                            calendar1.addEvent(singleDateClicks[i]);
                        }
                    }
                    if (!isObjectEmpty(eventObj2)) {
                        calendar1.addEvent(eventObj2);
                    }
                    $("#periodeModal").modal("hide");
                });
            });
        </script>
    </head>
    <body>
        <div id="calendar1"></div>
        <div
            class="modal fade"
            id="onDateClickModal"
            tabindex="-1"
            aria-labelledby="onDateClickModalLabel"
            aria-hidden="true"
            data-bs-backdrop="static"
        >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <h2 class="text-start text-success" id="dateDate"></h2>
                        <p class="text-start fw-bold text-success mx-5">
                            status: <span id="dateStatus"></span>
                        </p>
                        <h4 class="text-start text-success mx-5">Ændre dit tidsrum</h4>
                        <div class="d-flex justify-content-center mx-auto">
                            <label for="startTime" class="text-success mx-3" data-fra-ledig="fra"
                                >Fra
                                <input type="time" id="fra" class="form-control ml-2" />
                            </label>
                            <label for="name" class="text-success mx-3" data-til-ledig="til"
                                >Til
                                <input type="time" id="til" class="form-control ml-2" />
                            </label>
                        </div>
                    </div>
                    <div class="text-center my-4">
                        <button type="button" id="clearDateInfo" class="btn btn-danger">
                            afmeld
                        </button>
                        <button type="button" id="saveDateInfo" class="btn btn-success">gem</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="calendar-wrapper" id="calendar-wrapper"></div>

        <!-- Modal -->

        <!-- Button trigger modal -->
        <div class="text-center my-5">
            <button
                type="button"
                class="btn btn-success"
                data-bs-toggle="modal"
                data-bs-target="#periodeModal"
                id="availability"
            >
                Rediger rådighed
            </button>
        </div>

        <!-- Modal -->
        <div
            class="modal fade"
            id="periodeModal"
            tabindex="-1"
            aria-labelledby="periodeModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <h2 class="text-center text-success mb-5">Vælg periode eller dato</h2>
                        <div class="d-flex justify-content-center mx-auto">
                            <label class="text-success mx-3"
                                >Fra
                                <input type="date" id="datoStart" class="form-control" />
                            </label>
                            <label class="text-success mx-3"
                                >Til
                                <input type="date" id="datoEnd" class="form-control" />
                            </label>
                        </div>
                        <div class="text-center my-5">
                            <button type="button" class="btn btn-success" id="savePeriod">
                                Gem periode
                            </button>
                        </div>
                        <div class="calendar my-4" id="calendar2"></div>
                    </div>

                    <div class="text-center my-4">
                        <button type="button" class="btn btn-success" id="saveToCalender">
                            Gem
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
